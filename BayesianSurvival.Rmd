---
title: "BayesianSurvival"
author: "Yufang"
date: "2025-02-19"
output: pdf_document
---

# load packages
```{r, echo=TRUE}
rm(list = ls())
# install.packages("rstan")
# install.packages("readr")
library(rstan)
library(readr)
```

# build up models
```{r, echo=TRUE}
# set the bayesian survival model
# simple survival analysis without covariates

## The exponential survival model and the prior are coded directly using vectorized distribution and ccdf statements. 
# The likelihood for rate lambda is just the density of exponential distribution for observed failure time. 
code_bayesian_survival_0 <- "
  data { 
    int<lower=0> N; // the number of uncensored observations
    vector[N] t; // the times of the uncensored observations
    int<lower=0> N_cens; // the number of censored items that are right censored at time t_cens
    real<lower=0> t_cens; // it is only observed that the part survived until time t_cens.
  }
  parameters {
    real<lower=0> lambda;
  }
  model {
    t ~ exponential(lambda);
    target += N_cens * exponential_lccdf(t_cens | lambda);
    lambda ~ lognormal(0, 1); 
  }
"
```

# compile the model
```{r, echo=TRUE}
pmt <- proc.time()
bayesian_survival_0 <- stan_model(model_name = "bayesian_survival_0", 
                                         model_code = code_bayesian_survival_0)
proc.time()-pmt
```

# get a simulated dataset & prepare it for stan
```{r, echo=TRUE}
# Load necessary libraries
library(dplyr)

# Set seed for reproducibility
set.seed(42)

# Parameters for the simulation
N <- 100  # Number of observations
lambda_true <- 0.1  # True rate parameter for the exponential distribution
censoring_time <- 12  # Censoring time

# Simulate survival times from an exponential distribution
survival_times <- rexp(N, rate = lambda_true)

# Simulate censoring indicator (1 if censored, 0 if not)
censored <- survival_times > censoring_time
observed_times <- ifelse(censored, censoring_time, survival_times)

# Create a data frame to store the simulated data
simulated_data <- data.frame(
  observed_times = observed_times,
  censored = as.integer(censored)
)

## prepare the simulated data for stan
stan_data <- list(
  N = nrow(simulated_data),
  t = simulated_data$observed_times,
  N_cens = sum(simulated_data$censored),
  t_cens = 12 # Censoring time used in the simulation
)
```

# fit the model on the data
```{r, echo=TRUE}

#' Sampling from the model
niter = 10000; nwarmup = 1000 
Bayint <- suppressWarnings(sampling(bayesian_survival_0, data = stan_data, iter = niter, 
                                    warmup = nwarmup, thin = 10, chain = 1))
#' Summary of the fit
print(summary(Bayint)$summary)
```
